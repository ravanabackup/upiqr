<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live QR Code Error Correction Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #3498db, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            color: #34495e;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            font-size: 1.8em;
        }

        h3 {
            color: #2980b9;
            margin: 20px 0 15px 0;
            font-size: 1.4em;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3498db;
        }

        .formula {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            border: 2px solid #007bff;
            position: relative;
            overflow-x: auto;
        }

        .formula::before {
            content: "üìê";
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
        }

        .live-demo {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .demo-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        input, button, select {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input {
            border: 2px solid #ddd;
            background: white;
            color: #333;
            min-width: 200px;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .qr-workspace {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin: 30px 0;
        }

        .qr-display {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .qr-canvas {
            border: 3px solid #34495e;
            border-radius: 10px;
            margin: 15px auto;
            display: block;
            max-width: 100%;
            cursor: crosshair;
        }

        .qr-info {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 150px;
            text-align: left;
        }

        .damage-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .damage-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            font-size: 0.9em;
            padding: 8px 16px;
        }

        .repair-btn {
            background: linear-gradient(45deg, #27ae60, #229954);
            font-size: 0.9em;
            padding: 8px 16px;
        }

        .status-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }

        .status-good { background: #27ae60; }
        .status-damaged { background: #e74c3c; }
        .status-repairing { background: #f39c12; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #2980b9;
        }

        .upload-area.dragover {
            background: rgba(52, 152, 219, 0.2);
            border-color: #e74c3c;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .math-box {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #e91e63;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .step {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .step.active {
            background: rgba(52, 152, 219, 0.3);
            transform: translateY(-5px);
        }

        .step.complete {
            background: rgba(39, 174, 96, 0.3);
        }

        .camera-feed {
            width: 100%;
            height: auto;
            border-radius: 15px;
            border: 3px solid #3498db;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .demo-controls {
                flex-direction: column;
                align-items: stretch;
            }

            input, button {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üî≤ Live QR Code Error Correction Demo</h1>

        <div class="section">
            <h2>üöÄ Interactive QR Code Generator & Error Fixer</h2>
            <div class="live-demo">
                <div class="demo-controls">
                    <input type="text" id="qrText" placeholder="Enter text to encode..." value="HELLO WORLD">
                    <select id="errorLevel">
                        <option value="L">Low (7% recovery)</option>
                        <option value="M" selected>Medium (15% recovery)</option>
                        <option value="Q">Quartile (25% recovery)</option>
                        <option value="H">High (30% recovery)</option>
                    </select>
                    <button onclick="generateQR()">Generate QR</button>
                </div>
                <div class="step-indicator">
                    <div class="step" id="step1">üìù Encode</div>
                    <div class="step" id="step2">üîß Add Redundancy</div>
                    <div class="step" id="step3">üéØ Generate Pattern</div>
                    <div class="step" id="step4">‚úÖ Complete</div>
                </div>
                <div class="qr-workspace">
                    <div class="qr-display">
                        <h3><span class="status-indicator status-good"></span>Original QR Code</h3>
                        <canvas id="originalQR" class="qr-canvas" width="300" height="300"></canvas>
                        <div class="qr-info" id="originalInfo">Generate a QR code to start...</div>
                    </div>
                    <div class="qr-display">
                        <h3><span class="status-indicator status-damaged"></span>Damaged QR Code</h3>
                        <canvas id="damagedQR" class="qr-canvas" width="300" height="300"></canvas>
                        <div class="damage-controls">
                            <button class="damage-btn" onclick="addRandomDamage(10)">Light Damage (10%)</button>
                            <button class="damage-btn" onclick="addRandomDamage(20)">Heavy Damage (20%)</button>
                            <button class="damage-btn" onclick="addRandomDamage(30)">Extreme Damage (30%)</button>
                            <button class="damage-btn" onclick="addCustomDamage()">Draw Damage</button>
                        </div>
                        <div class="qr-info" id="damagedInfo">Click above to add damage...</div>
                    </div>
                    <div class="qr-display">
                        <h3><span class="status-indicator status-repairing"></span>Repaired QR Code</h3>
                        <canvas id="repairedQR" class="qr-canvas" width="300" height="300"></canvas>
                        <div class="progress-bar">
                            <div class="progress-fill" id="repairProgress"></div>
                        </div>
                        <button class="repair-btn" onclick="repairQR()" id="repairBtn">üîß Repair QR Code</button>
                        <div class="qr-info" id="repairInfo">Repair damaged QR to see recovery...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üì∑ Live QR Code Scanner</h2>
            <p>Point your camera at a QR code to scan it. This uses a real decoder library, which includes automatic error correction.</p>
            <div class="qr-workspace">
                <div class="qr-display">
                    <h3><span class="status-indicator status-repairing"></span>Camera Feed</h3>
                    <video id="cameraFeed" class="camera-feed" autoplay playsinline></video>
                    <button onclick="startScanner()">Start Camera</button>
                    <div class="qr-info" id="cameraInfo">Click 'Start Camera' to begin scanning...</div>
                    <canvas id="cameraCanvas" style="display:none;"></canvas>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üì§ Upload Your Own QR Code</h2>
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <h3>üñºÔ∏è Drop QR Code Image Here</h3>
                <p>Or click to select file</p>
                <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="handleFileUpload(event)">
            </div>
            <div class="qr-workspace" id="uploadedQRSection" style="display: none;">
                <div class="qr-display">
                    <h3>üì∑ Uploaded QR Code</h3>
                    <canvas id="uploadedQR" class="qr-canvas" width="300" height="300"></canvas>
                    <div class="qr-info" id="uploadedInfo">Processing uploaded image...</div>
                </div>
                <div class="qr-display">
                    <h3>üîç Analysis Results</h3>
                    <canvas id="analyzedQR" class="qr-canvas" width="300" height="300"></canvas>
                    <button onclick="analyzeUploadedQR()">üî¨ Analyze QR Code</button>
                    <div class="qr-info" id="analysisInfo">Click analyze to inspect QR structure...</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üßÆ Mathematical Foundation</h2>
            <div class="grid-container">
                <div class="math-box">
                    <h3>Reed-Solomon Error Correction</h3>
                    <div class="formula">
                        Generator Polynomial:
                        g(x) = ‚àè(i=0 to n-k-1) (x - Œ±^i)

                        Where:
                        - Œ± = primitive element in GF(256)
                        - n = total codeword length
                        - k = message length
                        - t = ‚åä(n-k)/2‚åã error correction capacity
                    </div>
                </div>
                <div class="math-box">
                    <h3>Error Detection Algorithm</h3>
                    <div class="formula">
                        Syndrome Calculation:
                        S_i = r(Œ±^i) for i = 1,2,...,2t

                        If all S_i = 0: No errors
                        Else: Solve error locator polynomial
                        Œõ(x) = ‚àè(j=1 to v) (1 - X_j x)

                        Error positions: Œ±^(-i) where Œõ(Œ±^(-i)) = 0
                    </div>
                </div>
            </div>
            <div class="math-box">
                <h3>Live Calculation Example</h3>
                <div class="formula" id="liveCalculation">
                    Generate a QR code to see Reed-Solomon calculations in real-time...
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üéØ How It Works</h2>
            <div class="grid-container">
                <div class="math-box">
                    <h3>1. Pattern Recognition</h3>
                    <p>QR codes use finder patterns with a specific 1:1:3:1:1 ratio to establish orientation and size. The algorithm scans for these patterns first.</p>
                </div>
                <div class="math-box">
                    <h3>2. Data Extraction</h3>
                    <p>Once patterns are found, the algorithm reads data in a zigzag pattern, applying the appropriate mask to recover the original binary data.</p>
                </div>
                <div class="math-box">
                    <h3>3. Error Correction</h3>
                    <p>Reed-Solomon codes detect and correct errors by evaluating polynomials at specific points in the Galois field GF(256).</p>
                </div>
                <div class="math-box">
                    <h3>4. Data Recovery</h3>
                    <p>Using syndrome decoding, the algorithm locates and corrects corrupted bits, recovering the original message even with significant damage.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for managing state
        let currentQRData = null;
        let isDrawingDamage = false;
        let animationFrameId = null;

        // --- QR Code Generation and Display ---

        async function generateQR() {
            const text = document.getElementById('qrText').value || 'HELLO WORLD';
            const errorLevel = document.getElementById('errorLevel').value;

            try {
                const dataUrl = await QRCode.toDataURL(text, {
                    errorCorrectionLevel: errorLevel
                });

                const originalCanvas = document.getElementById('originalQR');
                const ctx = originalCanvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    ctx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
                    ctx.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);

                    updateQRInfo('originalInfo', {
                        text: text,
                        errorLevel: errorLevel,
                        size: `${img.width}x${img.height}`,
                        capacity: calculateCapacity(errorLevel),
                        binary: 'Encoded by a real QR library.'
                    });

                    const damagedCanvas = document.getElementById('damagedQR');
                    damagedCanvas.getContext('2d').clearRect(0, 0, damagedCanvas.width, damagedCanvas.height);
                    damagedCanvas.getContext('2d').drawImage(img, 0, 0, damagedCanvas.width, damagedCanvas.height);

                    const repairedCanvas = document.getElementById('repairedQR');
                    repairedCanvas.getContext('2d').clearRect(0, 0, repairedCanvas.width, repairedCanvas.height);

                    animateSteps();
                    updateLiveCalculation(text, errorLevel);

                    currentQRData = {
                        text,
                        errorLevel,
                        imageData: ctx.getImageData(0, 0, originalCanvas.width, originalCanvas.height)
                    };
                };
                img.src = dataUrl;
            } catch (err) {
                console.error(err);
                alert('Failed to generate QR code. Check the console for details.');
            }
        }

        function animateSteps() {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            steps.forEach((step, index) => {
                const element = document.getElementById(step);
                element.className = 'step';

                setTimeout(() => {
                    element.className = 'step active';
                    setTimeout(() => {
                        element.className = 'step complete';
                    }, 500);
                }, index * 300);
            });
        }

        function updateQRInfo(elementId, info) {
            const element = document.getElementById(elementId);
            element.textContent = `Text: "${info.text}"\nError Level: ${info.errorLevel}\nSize: ${info.size}\nRecovery: ${info.capacity}\nBinary: ${info.binary || 'N/A'}`;
        }

        function calculateCapacity(level) {
            const capacities = {
                'L': '~7% damage recovery',
                'M': '~15% damage recovery',
                'Q': '~25% damage recovery',
                'H': '~30% damage recovery'
            };
            return capacities[level];
        }

        function updateLiveCalculation(text, errorLevel) {
            const redundancy = {
                'L': 0.07,
                'M': 0.15,
                'Q': 0.25,
                'H': 0.30
            };
            const textLength = text.length;
            const errorBits = Math.ceil(textLength * 8 * redundancy[errorLevel]);
            const totalBits = textLength * 8 + errorBits;

            document.getElementById('liveCalculation').innerHTML = `Current Text: "${text}"\nBinary Length (approx): ${textLength * 8} bits\nError Level: ${errorLevel} (${(redundancy[errorLevel] * 100)}% redundancy)\nError Correction Bits: ${errorBits}\nTotal Capacity: ${totalBits} bits\n\nReed-Solomon Parameters:\n- Message length (k): (approx) ${textLength * 8}\n- Error correction length (n-k): (approx) ${errorBits}\n- Maximum correctable errors: (approx) ${Math.floor(errorBits / 2)}\n- Generator polynomial degree: (approx) ${errorBits}`;
        }

        // --- Damage and Repair Simulation ---

        function addRandomDamage(percentage) {
            if (!currentQRData) {
                alert('Generate a QR code first!');
                return;
            }
            const damagedCanvas = document.getElementById('damagedQR');
            const ctx = damagedCanvas.getContext('2d');
            const damagedImageData = ctx.getImageData(0, 0, damagedCanvas.width, damagedCanvas.height);
            
            const totalPixels = damagedImageData.data.length / 4;
            const damagePixels = Math.floor(totalPixels * percentage / 100);

            for (let i = 0; i < damagePixels; i++) {
                const pixelIndex = Math.floor(Math.random() * totalPixels) * 4;
                damagedImageData.data[pixelIndex] = Math.random() * 255;
                damagedImageData.data[pixelIndex + 1] = Math.random() * 255;
                damagedImageData.data[pixelIndex + 2] = Math.random() * 255;
                damagedImageData.data[pixelIndex + 3] = 255;
            }
            
            ctx.putImageData(damagedImageData, 0, 0);
            document.getElementById('damagedInfo').textContent = `Damaged: ${percentage}% corruption applied\nStatus: Needs repair\nRecovery possible: ${percentage <= 30 ? 'YES' : 'MAYBE'}`;
        }

        function addCustomDamage() {
            const canvas = document.getElementById('damagedQR');
            if (!currentQRData) {
                alert('Generate a QR code first!');
                return;
            }

            isDrawingDamage = true;
            canvas.style.cursor = 'crosshair';
            canvas.onmousedown = startDrawing;
            canvas.onmousemove = drawDamage;
            canvas.onmouseup = stopDrawing;

            alert('Click and drag on the damaged QR code to add custom damage!');
        }

        function startDrawing(e) {
            if (!isDrawingDamage) return;
            drawDamage(e);
        }

        function drawDamage(e) {
            if (!isDrawingDamage || e.buttons !== 1) return;
            const canvas = document.getElementById('damagedQR');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.fillStyle = `rgb(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255})`;
            ctx.fillRect(x - 5, y - 5, 10, 10);
        }

        function stopDrawing() {
            isDrawingDamage = false;
            const canvas = document.getElementById('damagedQR');
            canvas.style.cursor = 'default';
            canvas.onmousedown = null;
            canvas.onmousemove = null;
            canvas.onmouseup = null;
            document.getElementById('damagedInfo').textContent = `Custom damage applied\nStatus: Ready for repair\nClick repair button to fix`;
        }

        async function repairQR() {
            const damagedCanvas = document.getElementById('damagedQR');
            const damagedCtx = damagedCanvas.getContext('2d');
            const damagedImageData = damagedCtx.getImageData(0, 0, damagedCanvas.width, damagedCanvas.height);

            const progressBar = document.getElementById('repairProgress');
            const repairBtn = document.getElementById('repairBtn');
            repairBtn.disabled = true;
            repairBtn.textContent = 'üîß Repairing...';

            let progress = 0;
            const repairInterval = setInterval(async () => {
                progress += 2;
                progressBar.style.width = progress + '%';

                if (progress >= 100) {
                    clearInterval(repairInterval);

                    const code = jsQR(damagedImageData.data, damagedImageData.width, damagedImageData.height);
                    const repairedCanvas = document.getElementById('repairedQR');
                    const repairedCtx = repairedCanvas.getContext('2d');
                    repairedCtx.clearRect(0, 0, repairedCanvas.width, repairedCanvas.height);

                    if (code) {
                        const repairedDataUrl = await QRCode.toDataURL(code.data, {
                            errorCorrectionLevel: currentQRData.errorLevel
                        });

                        const repairedImg = new Image();
                        repairedImg.onload = () => {
                            repairedCtx.drawImage(repairedImg, 0, 0, repairedCanvas.width, repairedCanvas.height);
                            document.getElementById('repairInfo').textContent = `Repair complete!\nDecoded Text: "${code.data}"\nStatus: SUCCESS`;
                        };
                        repairedImg.src = repairedDataUrl;
                    } else {
                        document.getElementById('repairInfo').textContent = `Repair failed.\nDamage too severe to be corrected with a level of ${currentQRData.errorLevel}`;
                    }

                    repairBtn.disabled = false;
                    repairBtn.textContent = 'üîß Repair Again';
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 2000);
                }
            }, 50);
        }

        // --- Live Camera Scanner ---

        async function startScanner() {
            const video = document.getElementById('cameraFeed');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            const infoElement = document.getElementById('cameraInfo');

            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: "environment"
                        }
                    });
                    video.srcObject = stream;
                    video.setAttribute('playsinline', true);
                    video.play();
                    infoElement.textContent = 'Camera started. Scanning for QR code...';
                    requestAnimationFrame(tick);
                } else {
                    infoElement.textContent = 'Camera not supported on this device.';
                }
            } catch (err) {
                console.error(err);
                infoElement.textContent = 'Error: Could not access camera. Please ensure permissions are granted.';
            }

            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert"
                    });

                    if (code) {
                        infoElement.textContent = `QR Code Found!\nData: ${code.data}`;
                        video.pause();
                        if (animationFrameId) {
                            cancelAnimationFrame(animationFrameId);
                        }
                        return;
                    }
                }
                animationFrameId = requestAnimationFrame(tick);
            }
        }

        // --- Upload and Analysis ---

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    displayUploadedQR(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayUploadedQR(img) {
            const canvas = document.getElementById('uploadedQR');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            document.getElementById('uploadedQRSection').style.display = 'block';
            document.getElementById('uploadedInfo').textContent = `Uploaded QR Code\nSize: ${img.width} x ${img.height} pixels\nStatus: Ready for analysis\nClick 'Analyze QR Code' to inspect structure`;
        }

        function analyzeUploadedQR() {
            const canvas = document.getElementById('uploadedQR');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            const analysisInfoElement = document.getElementById('analysisInfo');
            const analyzedQRCanvas = document.getElementById('analyzedQR');
            const analyzedCtx = analyzedQRCanvas.getContext('2d');

            if (code) {
                analyzedCtx.clearRect(0, 0, analyzedQRCanvas.width, analyzedQRCanvas.height);
                analyzedCtx.drawImage(canvas, 0, 0, analyzedQRCanvas.width, analyzedQRCanvas.height);

                const {
                    topLeftCorner,
                    topRightCorner,
                    bottomLeftCorner,
                    bottomRightCorner
                } = code.location;

                analyzedCtx.beginPath();
                analyzedCtx.moveTo(topLeftCorner.x, topLeftCorner.y);
                analyzedCtx.lineTo(topRightCorner.x, topRightCorner.y);
                analyzedCtx.lineTo(bottomRightCorner.x, bottomRightCorner.y);
                analyzedCtx.lineTo(bottomLeftCorner.x, bottomLeftCorner.y);
                analyzedCtx.lineTo(topLeftCorner.x, topLeftCorner.y);
                analyzedCtx.lineWidth = 4;
                analyzedCtx.strokeStyle = "#FF3B58";
                analyzedCtx.stroke();
                
                analysisInfoElement.textContent = `QR Code Analysis:\nDecoded: ‚úÖ\nText: "${code.data}"\nStatus: OK\n\nNote: The red line highlights the detected QR code boundaries.`;
            } else {
                analyzedCtx.clearRect(0, 0, analyzedQRCanvas.width, analyzedQRCanvas.height);
                analyzedCtx.drawImage(canvas, 0, 0, analyzedQRCanvas.width, analyzedQRCanvas.height);
                
                analysisInfoElement.textContent = `QR Code Analysis:\nDecoded: ‚ùå\nStatus: Could not decode.\n\nPossible reasons:\n- Too much damage\n- Poor image quality\n- Not a valid QR code`;
            }
        }

        // --- Drag and drop functionality ---

        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                const event = {
                    target: {
                        files: files
                    }
                };
                handleFileUpload(event);
            }
        });

        // Initialize
        window.onload = function() {
            generateQR();
        };
    </script>
</body>
</html>
